{% extends "base.html" %}

{% block title %}Scraper Management Â· Athena Live{% endblock %}

{% block content %}
<section>
    <h2>Scraper Management</h2>
    <p class="lead">
        Review existing scraper scripts, adjust their schedules, and generate new scrapers using the form below.
    </p>
</section>

<section>
    <h3>Create a New Scraper</h3>
    <form method="post" class="create-form">
        {% csrf_token %}
        <input type="hidden" name="action" value="create">
        <div>
            <label for="id_company">Company</label>
            {{ create_form.company }}
            {% if create_form.company.help_text %}<small>{{ create_form.company.help_text }}</small>{% endif %}
            {% if create_form.company.errors %}
                <div class="error">{{ create_form.company.errors|join:", " }}</div>
            {% endif %}
        </div>
        <div>
            <label for="id_url">Target URL</label>
            {{ create_form.url }}
            {% if create_form.url.help_text %}<small>{{ create_form.url.help_text }}</small>{% endif %}
            {% if create_form.url.errors %}
                <div class="error">{{ create_form.url.errors|join:", " }}</div>
            {% endif %}
        </div>
        <div>
            <label for="id_interval_hours">Interval (hours)</label>
            {{ create_form.interval_hours }}
            {% if create_form.interval_hours.help_text %}<small>{{ create_form.interval_hours.help_text }}</small>{% endif %}
            {% if create_form.interval_hours.errors %}
                <div class="error">{{ create_form.interval_hours.errors|join:", " }}</div>
            {% endif %}
        </div>
        <div>
            <label for="id_active">
                {{ create_form.active }} Schedule immediately
            </label>
            {% if create_form.active.help_text %}<small>{{ create_form.active.help_text }}</small>{% endif %}
            {% if create_form.active.errors %}
                <div class="error">{{ create_form.active.errors|join:", " }}</div>
            {% endif %}
        </div>
        <button type="submit">Generate Scraper</button>
    </form>
</section>

<section>
    <h3>Existing Scrapers</h3>
    {% if scrapers %}
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Company</th>
                    <th>URL</th>
                    <th>Interval (hours)</th>
                    <th>Active</th>
                    <th>Last Run</th>
                    <th>Created</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for scraper in scrapers %}
                    <tr>
                        <td>{{ scraper.id }}</td>
                        <td>{{ scraper.company }}</td>
                        <td><a href="{{ scraper.url }}" target="_blank" rel="noopener">{{ scraper.url }}</a></td>
                        <td>
                            <form method="post" class="inline-form">
                                {% csrf_token %}
                                <input type="hidden" name="action" value="update">
                                <input type="hidden" name="scraper_id" value="{{ scraper.id }}">
                                <input type="number" name="interval_hours" value="{{ scraper.interval_hours }}" min="1" step="1" required>
                                <button type="submit">Update</button>
                            </form>
                        </td>
                        <td>
                            {% if scraper.active %}
                                <span class="status status-active">Active</span>
                            {% else %}
                                <span class="status status-paused">Paused</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if scraper.last_run %}
                                {{ scraper.last_run|date:"Y-m-d H:i" }}
                            {% else %}
                                Never
                            {% endif %}
                        </td>
                        <td>{{ scraper.created_at|date:"Y-m-d H:i" }}</td>
                        <td class="actions">
                            <form method="post" class="inline-form">
                                {% csrf_token %}
                                <input type="hidden" name="action" value="toggle">
                                <input type="hidden" name="scraper_id" value="{{ scraper.id }}">
                                <button type="submit">
                                    {% if scraper.active %}Pause{% else %}Activate{% endif %}
                                </button>
                            </form>
                            <form method="post" class="inline-form">
                                {% csrf_token %}
                                <input type="hidden" name="action" value="run">
                                <input type="hidden" name="scraper_id" value="{{ scraper.id }}">
                                <button type="submit">Run Now</button>
                            </form>
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <p>No scrapers created yet.</p>
    {% endif %}
</section>
{% endblock %}
